// Copyright 2021 The Simlin Authors. All rights reserved.
// Use of this source code is governed by the Apache License,
// Version 2.0, that can be found in the LICENSE file.

syntax = "proto3";

package project_io;

message GraphicalFunction {
  enum Kind {
    CONTINUOUS = 0;
    DISCRETE = 1;
    EXTRAPOLATE = 2;
  };
  message Scale {
    double min = 1;
    double max = 2;
  }
  Kind kind = 1;
  repeated double x_points = 2;
  repeated double y_points = 3;
  Scale x_scale = 4;
  Scale y_scale = 5;
}

message Variable {
  // access=output XMILE variables have public access, all others are private.
  enum Visibility {
    PRIVATE = 0;
    PUBLIC = 1;
  };

  message ScalarEquation {
    string equation = 1;
    optional string initial_equation = 2;
  };

  message ApplyToAllEquation {
    repeated string dimension_names = 1;
    string equation = 2;
    optional string initial_equation = 3;
  };

  message ArrayedEquation {
    message Element {
      string subscript = 1;
      string equation = 2;
      optional string initial_equation = 3;
      optional GraphicalFunction gf = 4;
    };

    repeated string dimension_names = 1;
    repeated Element elements = 2;
  };

  message Equation {
    oneof equation {
      ScalarEquation scalar = 1;
      ApplyToAllEquation apply_to_all = 2;
      ArrayedEquation arrayed = 3;
    }
  };

  message Stock {
    string ident = 1;
    Equation equation = 8;
    string documentation = 3;
    string units = 4;
    repeated string inflows = 5;
    repeated string outflows = 6;
    bool non_negative = 7;
    bool can_be_module_input = 9;
    Visibility visibility = 10;
    int32 uid = 11;
  };

  message Flow {
    string ident = 1;
    Equation equation = 8;
    string documentation = 3;
    string units = 4;
    GraphicalFunction gf = 5;
    bool non_negative = 7;
    bool can_be_module_input = 9;
    Visibility visibility = 10;
    int32 uid = 11;
  };

  message Aux {
    string ident = 1;
    Equation equation = 6;
    string documentation = 3;
    string units = 4;
    GraphicalFunction gf = 5;
    bool can_be_module_input = 7;
    Visibility visibility = 8;
    int32 uid = 9;
  };

  message Module {
    message Reference {
      string src = 1;
      string dst = 2;
    };

    string ident = 1;
    string model_name = 2;
    string documentation = 3;
    string units = 4;
    repeated Reference references = 5;
    bool can_be_module_input = 6;
    Visibility visibility = 7;
    int32 uid = 8;
  };

  oneof v {
    Stock stock = 1;
    Flow flow = 2;
    Aux aux = 3;
    Module module = 4;
  }
};

message ViewElement {
  enum LabelSide {
    TOP = 0;
    LEFT = 1;
    CENTER = 2;
    BOTTOM = 3;
    RIGHT = 4;
  };

  message Aux {
    string name = 1;
    int32 uid = 2;
    double x = 3;
    double y = 4;
    LabelSide label_side = 5;
  };

  message Stock {
    string name = 1;
    int32 uid = 2;
    double x = 3;
    double y = 4;
    LabelSide label_side = 5;
  };

  message FlowPoint {
    double x = 1;
    double y = 2;
    int32 attached_to_uid = 3;
  }

  message Flow {
    string name = 1;
    int32 uid = 2;
    double x = 3;
    double y = 4;
    LabelSide label_side = 5;
    // int32 segmentWithAux = 3;
    // double auxPercentageIntoSegment = 4;
    repeated FlowPoint points = 6;
  };

  message Link {
    enum Polarity {
      POLARITY_UNSPECIFIED = 0;
      POLARITY_POSITIVE = 1;
      POLARITY_NEGATIVE = 2;
    }
    message LinkPoints {
      repeated FlowPoint points = 1;
    }
    int32 uid = 1;
    int32 from_uid = 2;
    int32 to_uid = 3;
    oneof shape {
      double arc = 4; // [0, 360)
      bool is_straight = 5;
      LinkPoints multi_point = 6;
    }
    Polarity polarity = 7;
  };

  message Module {
    string name = 1;
    int32 uid = 2;
    double x = 3;
    double y = 4;
    LabelSide label_side = 5;
  };

  message Alias {
    int32 uid = 1;
    int32 alias_of_uid = 2;
    double x = 3;
    double y = 4;
    LabelSide label_side = 5;
  };

  message Cloud {
    int32 uid = 1;
    int32 flow_uid = 2;
    double x = 3;
    double y = 4;
  };

  // Visual container for grouping related model elements.
  // x/y are center coordinates (matching the internal convention).
  message Group {
    int32 uid = 1;
    string name = 2;
    double x = 3;
    double y = 4;
    double width = 5;
    double height = 6;
  };

  oneof element {
    Aux aux = 1;
    Stock stock = 2;
    Flow flow = 3;
    Link link = 4;
    Module module = 5;
    Alias alias = 6;
    Cloud cloud = 7;
    Group group = 8;
  }
}

message Rect {
  double x = 1;
  double y = 2;
  double width = 3;
  double height = 4;
};

message View {
  enum ViewType {
    STOCK_FLOW = 0;
    // INTERFACE = 1;
    // POPUP = 2;
    // VENDOR_SPECIFIC = 3;
  };

  ViewType kind = 1;
  // background
  repeated ViewElement elements = 3;
  Rect viewBox = 4;
  double zoom = 5;
};

message LoopMetadata {
  repeated int32 uids = 1;
  bool deleted = 2;
  string name = 3;
  string description = 4;
}

// Semantic/organizational group for categorizing model variables.
// This is distinct from visual diagram groups (ViewElement.Group).
// In Vensim, these are called "sectors".
message ModelGroup {
  string name = 1;
  string doc = 2;
  string parent = 3;
  repeated string members = 4;
  bool run_enabled = 5;
}

message Model {
  string name = 1;
  // namespaces
  // no 'resource' or sim_specs in our normalized form
  repeated Variable variables = 3;
  repeated View views = 4;
  repeated LoopMetadata loop_metadata = 5;
  repeated ModelGroup groups = 6;
}

enum SimMethod {
  EULER = 0;
  RUNGE_KUTTA_4 = 1;
  RUNGE_KUTTA_2 = 3;
}

message Dt {
  double value = 1;
  bool is_reciprocal = 2;
}

message SimSpecs {
  double start = 1;
  double stop = 2;
  Dt dt = 3;
  optional Dt save_step = 4;
  SimMethod sim_method = 5;
  optional string time_units = 6;
};

message Dimension {
  message DimensionElements {
    repeated string elements = 1;
  };
  message DimensionSize {
    uint32 size = 1;
  };
  string name = 1;
  repeated string obsolete_elements = 2;
  oneof dimension {
    DimensionElements elements = 3;
    DimensionSize size = 4;
  }
  // Vensim dimension mapping: when this dimension "maps to" another,
  // elements of this dimension correspond positionally to elements of
  // the target dimension. e.g., "DimA: A1, A2, A3 -> DimB" means
  // A1<->B1, A2<->B2, A3<->B3. This is used when a variable indexed
  // by DimB references variables indexed by DimA.
  optional string maps_to = 5;
};

message Unit {
  string name = 1;
  string equation = 2;
  bool disabled = 3;
  repeated string alias = 4;
};

// often we want to import or export a project to a string; whether it is
// an XMILE model, Vensim, or something else.  This is very useful for
// debugging import problems, and can be used to send both the protobuf and
// XMILE output from the frontend to the filesystem
message Source {
  enum Extension {
    UNSPECIFIED = 0;
    XMILE = 1;
    VENSIM = 2;
  };
  Extension extension = 1;
  string content = 2;
};

message ProjectPatch {
  repeated ProjectOperation project_ops = 1;
  repeated ModelPatch models = 2;
};

message ModelPatch {
  string name = 1;
  repeated ModelOperation ops = 2;
};

message ProjectOperation {
  oneof op {
    SetSimSpecsOp set_sim_specs = 1;
    SetSourceOp set_source = 2;
  }
};

message ModelOperation {
  oneof op {
    UpsertStockOp upsert_stock = 1;
    UpsertFlowOp upsert_flow = 2;
    UpsertAuxOp upsert_aux = 3;
    UpsertModuleOp upsert_module = 4;
    DeleteVariableOp delete_variable = 5;
    RenameVariableOp rename_variable = 6;
    UpsertViewOp upsert_view = 7;
    DeleteViewOp delete_view = 8;
    UpdateStockFlowsOp update_stock_flows = 9;
  }
};

// Updates only the inflows/outflows of an existing stock, preserving all other fields.
// Use this when connecting/disconnecting flows from stocks in the UI.
message UpdateStockFlowsOp {
  string ident = 1;
  repeated string inflows = 2;
  repeated string outflows = 3;
};

message SetSimSpecsOp {
  SimSpecs sim_specs = 1;
};

message UpsertStockOp {
  Variable.Stock stock = 1;
};

message UpsertFlowOp {
  Variable.Flow flow = 1;
};

message UpsertAuxOp {
  Variable.Aux aux = 1;
};

message UpsertModuleOp {
  Variable.Module module = 1;
};

message DeleteVariableOp {
  string ident = 1;
};

message RenameVariableOp {
  string from = 1;
  string to = 2;
};

message UpsertViewOp {
  uint32 index = 1;
  View view = 2;
};

message DeleteViewOp {
  uint32 index = 1;
};

message SetSourceOp {
  Source source = 1;
};

message Project {
  string name = 1;
  SimSpecs sim_specs = 2;
  repeated Dimension dimensions = 4;
  repeated Unit units = 6;
  repeated Model models = 3;
  Source source = 5;
};

// the following are for serializing and deserializing the bytecode/data sent to the engine for a model

enum BuiltinId {
    UNSPECIFIED = 0;
    Abs = 1;
    Arccos = 2;
    Arcsin = 3;
    Arctan = 4;
    Cos = 5;
    Exp = 6;
    Inf = 7;
    Int = 8;
    Ln = 9;
    Log10 = 10;
    Max = 11;
    Min = 12;
    Pi = 13;
    Pulse = 14;
    Ramp = 15;
    SafeDiv = 16;
    Sin = 17;
    Sqrt = 18;
    Step = 19;
    Tan = 20;
    Sign = 21;
};