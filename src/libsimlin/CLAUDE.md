# libsimlin

Flat C FFI wrapper around `simlin-engine`. Exposes the engine through opaque pointer types with reference counting. Used from TypeScript (via WASM), Go (via CGo), and C/C++ (via `simlin.h`). See the root `CLAUDE.md` for full development guidelines; this file maps where functionality lives.

**Maintenance note**: Keep this file up to date when adding, removing, or reorganizing modules.

## Module map

All public FFI functions are prefixed with `simlin_` and declared `extern "C"`. The C header `simlin.h` is generated by cbindgen (configured in `cbindgen.toml`).

- **`src/lib.rs`** - Module declarations, shared types, and re-exports. Key types:
  - `SimlinProject` - Mutex-wrapped `engine::Project` with atomic refcount
  - `SimlinModel` - Model handle holding a project reference and model name
  - `SimState` - Internal simulation state container
  - `SimlinErrorCode` enum (35+ variants), `SimlinErrorKind`, `SimlinUnitErrorKind`
- **`src/ffi.rs`** - Opaque FFI marker types for cbindgen (`SimlinProject`, `SimlinSim`, `SimlinModel`, `SimlinError`) and C-compatible structs (`SimlinLoop`, `SimlinLoops`, `SimlinLink`, `SimlinLinks`, `SimlinLoopPolarity`, `SimlinLinkPolarity`, `SimlinJsonFormat`)
- **`src/ffi_error.rs`** - Rich error objects for FFI: `ErrorDetail` builder, `OwnedDetail` with CStrings, `SimlinError` struct with code/message/details array, `FfiError` wrapper for anyhow chains
- **`src/errors.rs`** - Human-readable error formatting: `FormattedError`/`FormattedErrors`, `collect_formatted_issues()`, per-category formatters (project/model/equation/unit/simulation errors)

### Project lifecycle

- **`src/project.rs`** - Load, reference-count, and query projects:
  - `simlin_project_open_{protobuf,json,xmile,vensim}()` - Load from various formats
  - `simlin_project_{ref,unref}()` - Reference counting
  - `simlin_project_get_model()` - Get model handle by name (or default)
  - `simlin_project_enable_ltm()` - Enable loop analysis
  - `simlin_project_is_simulatable()` - Check compilability

### Simulation lifecycle

- **`src/simulation.rs`** - Create, run, and query simulations:
  - `simlin_sim_new()` - Compile and create simulation (with optional LTM)
  - `simlin_sim_{ref,unref}()` - Reference counting
  - `simlin_sim_run_to()`, `simlin_sim_run_to_end()`, `simlin_sim_reset()`
  - `simlin_sim_get_value()`, `simlin_sim_set_value()`, `simlin_sim_get_series()`, `simlin_sim_get_initial_value()`

### Model queries

- **`src/model.rs`** - Inspect model structure:
  - `simlin_model_{ref,unref}()`, `simlin_model_get_var_count()`, `simlin_model_get_var_names()`
  - `simlin_model_get_dependencies()`, `simlin_model_get_links()`, `simlin_model_get_equations()`

### Serialization

- **`src/serialization.rs`** - Export projects:
  - `simlin_project_serialize_{protobuf,json,xmile,svg}()`

### Analysis

- **`src/analysis.rs`** - Feedback loop and causal link analysis:
  - `simlin_analyze_get_loops()`, `simlin_analyze_get_links()`, `simlin_analyze_get_rel_loop_score()`
  - `simlin_free_loops()`, `simlin_free_links()`

### Patching

- **`src/patch.rs`** - JSON patch application:
  - JSON patch types (`JsonProjectPatch`, `JsonModelPatch`, `JsonProjectOperation`, `JsonModelOperation`)
  - `simlin_project_apply_patch()` with dry-run support
  - `convert_json_project_patch()`, `convert_json_model_patch()` - JSON to engine patch conversion

### Infrastructure

- **`src/error_api.rs`** - Error inspection FFI: `simlin_error_{str,free,get_code,get_message,get_detail_count,get_details,get_detail}()`, ABI validation (`simlin_sizeof_*`)
- **`src/memory.rs`** - Custom allocator for WASM compatibility: `simlin_malloc()`, `simlin_free()`, `simlin_free_string()`

## Tests

- **`src/tests_remaining.rs`** - FFI integration tests (JSON roundtrips, null pointer handling)
- **`testdata/`** - Test models: `SIR.mdl`, `SIR.stmx`, `SIR_output.csv`, `SIR_project.pb`
