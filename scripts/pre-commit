#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Determine repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

echo "The project passed all pre-commit checks before your changes. Any failing checks reported are the result of your changes and need to be fixed by addressing their root cause." >&2

echo "Running pre-commit checks..."

cd "$REPO_ROOT"


# 0. Policy and lint checks (fast, run first)
echo -n "Checking dependency policy... "
DEPS_OUTPUT="$(mktemp)"
if python3 scripts/check-deps.py > "$DEPS_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$DEPS_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Dependency policy violation:${NC}"
    cat "$DEPS_OUTPUT"
    rm -f "$DEPS_OUTPUT"
    echo -e "${YELLOW}See doc/architecture.md for the dependency graph${NC}"
    exit 1
fi

echo -n "Checking documentation links... "
DOCS_OUTPUT="$(mktemp)"
if python3 scripts/check-docs.py > "$DOCS_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$DOCS_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Documentation link errors:${NC}"
    cat "$DOCS_OUTPUT"
    rm -f "$DOCS_OUTPUT"
    exit 1
fi

echo -n "Running project lint rules... "
PLINT_OUTPUT="$(mktemp)"
if bash scripts/lint-project.sh > "$PLINT_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$PLINT_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Project lint check failed:${NC}"
    cat "$PLINT_OUTPUT"
    rm -f "$PLINT_OUTPUT"
    exit 1
fi

# 1. Check Rust formatting
echo -n "Checking Rust code formatting... "
if cargo fmt --check >/dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Rust code needs formatting${NC}"
    echo -e "${YELLOW}Run 'cargo fmt' to fix formatting${NC}"
    exit 1
fi

# 1b. Check simlin.h is up to date with cbindgen
echo -n "Checking simlin.h freshness... "
CBINDGEN_OUTPUT="$(mktemp)"
if cbindgen --config src/libsimlin/cbindgen.toml --crate simlin --output "$CBINDGEN_OUTPUT" 2>/dev/null && diff -q src/libsimlin/simlin.h "$CBINDGEN_OUTPUT" >/dev/null 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$CBINDGEN_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}src/libsimlin/simlin.h is out of date${NC}"
    echo -e "${YELLOW}Run 'cbindgen --config src/libsimlin/cbindgen.toml --crate simlin --output src/libsimlin/simlin.h' to regenerate${NC}"
    rm -f "$CBINDGEN_OUTPUT"
    exit 1
fi

# 2. Run Rust clippy
echo -n "Running Rust clippy... "
CLIPPY_OUTPUT="$(mktemp)"
if cargo clippy --all-targets --all-features -- -D warnings > "$CLIPPY_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$CLIPPY_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Clippy found issues:${NC}"
    cat "$CLIPPY_OUTPUT"
    rm -f "$CLIPPY_OUTPUT"
    echo -e "${YELLOW}Run 'cargo clippy --all-targets --all-features -- -D warnings' to see errors${NC}"
    exit 1
fi

# 3. Run Rust tests
echo -n "Running Rust tests... "
TEST_OUTPUT="$(mktemp)"
if RUST_BACKTRACE=1 cargo test > "$TEST_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$TEST_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Rust tests failed:${NC}"
    cat "$TEST_OUTPUT"
    rm -f "$TEST_OUTPUT"
    echo -e "${YELLOW}Run 'cargo test' to see failures${NC}"
    exit 1
fi

# Check if node_modules exists
if [ ! -d "node_modules" ]; then
    echo -e "${RED}node_modules is missing.${NC}"
    echo -e "${YELLOW}Run './scripts/dev-init.sh' to install dependencies and configure the environment.${NC}"
    exit 1
fi

echo -n "Running TypeScript/JavaScript linting... "
LINT_OUTPUT="$(mktemp)"
if pnpm lint > "$LINT_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$LINT_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Linting failed:${NC}"
    cat "$LINT_OUTPUT"
    rm -f "$LINT_OUTPUT"
    echo -e "${YELLOW}Run 'pnpm lint' to see errors${NC}"
    exit 1
fi

# Build WASM and TS packages before type-checking, so that
# .d.ts files from project references are up to date.
echo -n "Building WASM module... "
BUILD_OUTPUT="$(mktemp)"
if pnpm build > "$BUILD_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$BUILD_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}WASM build failed:${NC}"
    cat "$BUILD_OUTPUT"
    rm -f "$BUILD_OUTPUT"
    echo -e "${YELLOW}Run 'pnpm build' to see errors${NC}"
    exit 1
fi

echo -n "Checking TypeScript types... "
TSC_OUTPUT="$(mktemp)"
if pnpm tsc > "$TSC_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$TSC_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}TypeScript type checking failed:${NC}"
    cat "$TSC_OUTPUT"
    rm -f "$TSC_OUTPUT"
    echo -e "${YELLOW}Run 'pnpm tsc' to see errors${NC}"
    exit 1
fi

echo -n "Running TypeScript tests... "
TS_TEST_OUTPUT="$(mktemp)"
if pnpm test > "$TS_TEST_OUTPUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$TS_TEST_OUTPUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}TypeScript tests failed:${NC}"
    cat "$TS_TEST_OUTPUT"
    rm -f "$TS_TEST_OUTPUT"
    echo -e "${YELLOW}Run 'pnpm test' to see failures${NC}"
    exit 1
fi

# 5. Run pysimlin (Python) bindings tests on Python 3.11+
echo -n "Running pysimlin tests (Python 3.11+)... "
PY_OUT="$(mktemp)"
if scripts/pysimlin-tests.sh > "$PY_OUT" 2>&1; then
    echo -e "${GREEN}✓${NC}"
    rm -f "$PY_OUT"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}pysimlin tests failed:${NC}"
    cat "$PY_OUT"
    rm -f "$PY_OUT"
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
