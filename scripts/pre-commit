#!/bin/bash
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Determine repository root
REPO_ROOT="$(git rev-parse --show-toplevel)"

echo "The project passed all pre-commit checks before your changes. Any failing checks reported are the result of your changes and need to be fixed by addressing their root cause." >&2

echo "Running pre-commit checks..."

cd "$REPO_ROOT"

# --- Phase 1: Fast policy checks (parallel) ---

POLICY_FAIL=0
DEPS_OUTPUT="$(mktemp)"
DOCS_OUTPUT="$(mktemp)"
PLINT_OUTPUT="$(mktemp)"

python3 scripts/check-deps.py > "$DEPS_OUTPUT" 2>&1 &
PID_DEPS=$!
python3 scripts/check-docs.py > "$DOCS_OUTPUT" 2>&1 &
PID_DOCS=$!
bash scripts/lint-project.sh > "$PLINT_OUTPUT" 2>&1 &
PID_PLINT=$!

echo -n "Checking dependency policy... "
if wait $PID_DEPS; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Dependency policy violation:${NC}"
    cat "$DEPS_OUTPUT"
    echo -e "${YELLOW}See doc/architecture.md for the dependency graph${NC}"
    POLICY_FAIL=1
fi
rm -f "$DEPS_OUTPUT"

echo -n "Checking documentation links... "
if wait $PID_DOCS; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Documentation link errors:${NC}"
    cat "$DOCS_OUTPUT"
    POLICY_FAIL=1
fi
rm -f "$DOCS_OUTPUT"

echo -n "Running project lint rules... "
if wait $PID_PLINT; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    echo -e "${RED}Project lint check failed:${NC}"
    cat "$PLINT_OUTPUT"
    POLICY_FAIL=1
fi
rm -f "$PLINT_OUTPUT"

if [ "$POLICY_FAIL" -ne 0 ]; then
    exit 1
fi

# --- Phase 2: Three parallel pipelines ---
#
# Pipeline A (Rust):  fmt -> cbindgen -> clippy & test (parallel)
# Pipeline B (TS):    lint (parallel) -> build -> tsc & test (parallel)
# Pipeline C (Python): pysimlin-tests.sh (builds release libsimlin internally)
#
# These pipelines are independent and run concurrently.

PIPELINE_A_OUT="$(mktemp)"
PIPELINE_B_OUT="$(mktemp)"
PIPELINE_C_OUT="$(mktemp)"

# Track PIDs for cleanup on failure
PIPELINE_PIDS=()

cleanup_pipelines() {
    for pid in "${PIPELINE_PIDS[@]}"; do
        kill "$pid" 2>/dev/null || true
        wait "$pid" 2>/dev/null || true
    done
    rm -f "$PIPELINE_A_OUT" "$PIPELINE_B_OUT" "$PIPELINE_C_OUT"
}

# --- Pipeline A: Rust ---
(
    set -e

    # 1. Check formatting
    echo "[rust] Checking formatting..."
    cargo fmt --check

    # 2. Check simlin.h freshness
    echo "[rust] Checking simlin.h freshness..."
    CBINDGEN_TMP="$(mktemp)"
    if cbindgen --config src/libsimlin/cbindgen.toml --crate simlin --output "$CBINDGEN_TMP" 2>/dev/null && diff -q src/libsimlin/simlin.h "$CBINDGEN_TMP" >/dev/null 2>&1; then
        rm -f "$CBINDGEN_TMP"
    else
        rm -f "$CBINDGEN_TMP"
        echo "src/libsimlin/simlin.h is out of date"
        echo "Run: cbindgen --config src/libsimlin/cbindgen.toml --crate simlin --output src/libsimlin/simlin.h"
        exit 1
    fi

    # 3. Clippy and tests in parallel (they share the build cache)
    echo "[rust] Running clippy and tests..."
    CLIPPY_TMP="$(mktemp)"
    TEST_TMP="$(mktemp)"

    cargo clippy --all-targets --all-features -- -D warnings > "$CLIPPY_TMP" 2>&1 &
    PID_CLIPPY=$!
    RUST_BACKTRACE=1 cargo test > "$TEST_TMP" 2>&1 &
    PID_TEST=$!

    RUST_FAIL=0
    if ! wait $PID_CLIPPY; then
        echo "Clippy found issues:"
        cat "$CLIPPY_TMP"
        RUST_FAIL=1
    fi
    if ! wait $PID_TEST; then
        echo "Rust tests failed:"
        cat "$TEST_TMP"
        RUST_FAIL=1
    fi
    rm -f "$CLIPPY_TMP" "$TEST_TMP"
    exit $RUST_FAIL
) > "$PIPELINE_A_OUT" 2>&1 &
PID_A=$!
PIPELINE_PIDS+=($PID_A)

# --- Pipeline B: TypeScript ---
(
    set -e

    # Check if node_modules exists
    if [ ! -d "node_modules" ]; then
        echo "node_modules is missing."
        echo "Run './scripts/dev-init.sh' to install dependencies and configure the environment."
        exit 1
    fi

    # 1. Lint (parallel across packages via pnpm)
    echo "[ts] Running linting..."
    pnpm -r --parallel run lint

    # 2. Build WASM and TS packages (needed for .d.ts files)
    echo "[ts] Building..."
    pnpm build

    # 3. Type check and tests in parallel
    echo "[ts] Running type check and tests..."
    TSC_TMP="$(mktemp)"
    TEST_TMP="$(mktemp)"

    pnpm tsc > "$TSC_TMP" 2>&1 &
    PID_TSC=$!
    pnpm test > "$TEST_TMP" 2>&1 &
    PID_TEST=$!

    TS_FAIL=0
    if ! wait $PID_TSC; then
        echo "TypeScript type checking failed:"
        cat "$TSC_TMP"
        TS_FAIL=1
    fi
    if ! wait $PID_TEST; then
        echo "TypeScript tests failed:"
        cat "$TEST_TMP"
        TS_FAIL=1
    fi
    rm -f "$TSC_TMP" "$TEST_TMP"
    exit $TS_FAIL
) > "$PIPELINE_B_OUT" 2>&1 &
PID_B=$!
PIPELINE_PIDS+=($PID_B)

# --- Pipeline C: Python ---
(
    set -e
    echo "[python] Running pysimlin tests..."
    scripts/pysimlin-tests.sh
) > "$PIPELINE_C_OUT" 2>&1 &
PID_C=$!
PIPELINE_PIDS+=($PID_C)

# --- Wait for all pipelines and report results ---

FAIL=0

echo -n "Running Rust checks (fmt, cbindgen, clippy, test)... "
if wait $PID_A; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    cat "$PIPELINE_A_OUT"
    FAIL=1
fi

echo -n "Running TypeScript checks (lint, build, tsc, test)... "
if wait $PID_B; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    cat "$PIPELINE_B_OUT"
    FAIL=1
fi

echo -n "Running pysimlin tests (Python 3.11+)... "
if wait $PID_C; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    cat "$PIPELINE_C_OUT"
    FAIL=1
fi

rm -f "$PIPELINE_A_OUT" "$PIPELINE_B_OUT" "$PIPELINE_C_OUT"

if [ "$FAIL" -ne 0 ]; then
    echo -e "${RED}Pre-commit checks failed!${NC}"
    exit 1
fi

echo -e "${GREEN}All pre-commit checks passed!${NC}"
