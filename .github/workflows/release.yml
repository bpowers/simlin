name: Build and Release

on:
  push:
    tags:
      - 'pysimlin-v*'
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-14]

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        if: runner.os == 'Linux'
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Build wheels with cibuildwheel
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_BUILD: cp311-* cp312-* cp313-*
          CIBW_SKIP: pp* *-musllinux*
          CIBW_ARCHS_MACOS: arm64
          CIBW_ARCHS_LINUX: x86_64 aarch64
          CIBW_BEFORE_ALL: |
            # Install uv for fast dependency management
            curl -LsSf https://astral.sh/uv/install.sh | sh
          CIBW_BEFORE_BUILD: |
            set -ex  # Exit on error and print commands
            export PATH="$HOME/.local/bin:$PATH"
            uv pip install --system cffi setuptools wheel
            # Install Rust if needed
            if ! command -v cargo >/dev/null 2>&1; then
              echo "Installing Rust..."
              curl https://sh.rustup.rs -sSf | sh -s -- -y --profile minimal --default-toolchain stable
              source "$HOME/.cargo/env"
            fi
            source "$HOME/.cargo/env" || true  # Ensure cargo is in PATH
            UNAME_S="$(uname -s)"; UNAME_M="$(uname -m)"
            if [ "$UNAME_S" = "Darwin" ] && [ "$UNAME_M" = "arm64" ]; then RUST_TARGET=aarch64-apple-darwin; fi
            if [ "$UNAME_S" = "Linux" ] && [ "$UNAME_M" = "x86_64" ]; then RUST_TARGET=x86_64-unknown-linux-gnu; fi
            if [ "$UNAME_S" = "Linux" ] && [ "$UNAME_M" = "aarch64" ]; then RUST_TARGET=aarch64-unknown-linux-gnu; fi
            echo "Adding Rust target: $RUST_TARGET"
            rustup target add "$RUST_TARGET"
            # Build in the project root to use workspace configuration
            echo "Building libsimlin..."
            cargo build --release --target "$RUST_TARGET" -p simlin
            # Copy library to where pysimlin expects it
            echo "Copying library..."
            mkdir -p src/libsimlin/target/release
            cp target/"$RUST_TARGET"/release/libsimlin.a src/libsimlin/target/release/
            ls -la src/libsimlin/target/release/  # Verify copy
        with:
          package-dir: src/pysimlin

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}
          path: wheelhouse/*.whl

  test-wheels:
    name: Test wheels
    needs: build-wheels
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, macos-14]
        python-version: ['3.11', '3.12', '3.13']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: wheelhouse
          merge-multiple: true

      - name: Install wheel and test dependencies
        run: |
          # Find the right wheel for this platform
          PYVER=$(python -c "import sys; print(f'cp{sys.version_info.major}{sys.version_info.minor}')")
          if [ "$RUNNER_OS" = "Linux" ]; then
            PLATFORM="manylinux"
            ARCH=$(uname -m)
            if [ "$ARCH" = "x86_64" ]; then
              WHEEL=$(ls wheelhouse/pysimlin-*-${PYVER}-*-${PLATFORM}*_x86_64.whl 2>/dev/null | head -1)
            else
              WHEEL=$(ls wheelhouse/pysimlin-*-${PYVER}-*-${PLATFORM}*_aarch64.whl 2>/dev/null | head -1)
            fi
          elif [ "$RUNNER_OS" = "macOS" ]; then
            # macOS ARM64
            WHEEL=$(ls wheelhouse/pysimlin-*-${PYVER}-*-macosx*_arm64.whl 2>/dev/null | head -1)
          fi

          if [ -z "$WHEEL" ]; then
            echo "No compatible wheel found for Python ${PYVER} on ${RUNNER_OS}"
            ls -la wheelhouse/
            exit 1
          fi

          echo "Installing wheel: $WHEEL"
          uv pip install --system "$WHEEL"

          # Install test dependencies explicitly (extras don't work reliably with local wheel paths)
          echo "Installing test dependencies..."
          uv pip install --system "pytest>=7.0.0" "pytest-cov>=4.0.0" "hypothesis>=6.100.0" "jsonschema>=4.20.0"

          # Debug: Check if the module was installed correctly
          echo "Checking installed package..."
          uv pip show --system pysimlin
          python -c "import simlin; print('simlin imported successfully')" || {
            echo "Failed to import simlin. Checking what's installed:"
            python -c "import sys; print(sys.path)"
            python -c "import site; print(site.getsitepackages())"
            ls -la $(python -c "import site; print(site.getsitepackages()[0])")/pysimlin* || true
            exit 1
          }

      - name: Run tests
        run: |
          # Run tests from a temporary directory to ensure we're testing the installed wheel
          # not the source code
          mkdir -p /tmp/test_run
          cd /tmp/test_run
          # Copy test files and pysimlin README (needed by test_readme_examples.py)
          cp -r ${{ github.workspace }}/src/pysimlin/tests .
          cp ${{ github.workspace }}/src/pysimlin/README.md .
          # Run tests against installed package
          # SIMLIN_REPO_ROOT tells tests where to find model files from the main repo
          SIMLIN_REPO_ROOT=${{ github.workspace }} RUST_BACKTRACE=1 pytest -q tests/

  publish:
    name: Publish to PyPI
    needs: test-wheels
    runs-on: ubuntu-24.04
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: wheelhouse
          merge-multiple: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}
          packages-dir: wheelhouse/
